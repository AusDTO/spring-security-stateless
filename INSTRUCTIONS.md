# Instructions

In order to use this library, the service or application must be using Spring Security for authentication.

## Spring Security configuration

The three key classes to wire up are [`au.gov.dto.springframework.security.web.context.CookieSecurityContextRepository`](src/main/java/au/gov/dto/springframework/security/web/context/CookieSecurityContextRepository.java), [`au.gov.dto.springframework.security.web.csrf.CookieCsrfTokenRepository`](src/main/java/au/gov/dto/springframework/security/web/csrf/CookieCsrfTokenRepository.java), and [`au.gov.dto.springframework.security.web.savedrequest.CookieRequestCache`](src/main/java/au/gov/dto/springframework/security/web/savedrequest/CookieRequestCache.java).

They provide implementations of these interfaces from Spring Security: [`org.springframework.security.web.context.SecurityContextRepository`](https://github.com/spring-projects/spring-security/blob/master/web/src/main/java/org/springframework/security/web/context/SecurityContextRepository.java), [`org.springframework.security.web.csrf.CsrfTokenRepository`](https://github.com/spring-projects/spring-security/blob/master/web/src/main/java/org/springframework/security/web/csrf/CsrfTokenRepository.java), and [`org.springframework.security.web.savedrequest.RequestCache`](https://github.com/spring-projects/spring-security/blob/master/web/src/main/java/org/springframework/security/web/savedrequest/RequestCache.java), respectively.

The default implementations of all three interfaces use [`javax.servlet.http.HttpSession`](http://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSession.html) to store information between user requests. Switching to the implementations provided by this library means `HttpSession` is no longer required for authentication.

## Authentication serialization 

`CookieSecurityContextRepository` uses [`au.gov.dto.springframework.security.web.context.AuthenticationSerializer`](src/main/java/au/gov/dto/springframework/security/web/context/AuthenticationSerializer.java) to serialize the [`org.springframework.security.core.Authentication`](https://github.com/spring-projects/spring-security/blob/master/core/src/main/java/org/springframework/security/core/Authentication.java) token generated by Spring Security. The supplied implementation of this interface is [`au.gov.dto.springframework.security.web.context.JsonAuthenticationSerializer`](src/main/java/au/gov/dto/springframework/security/web/context/JsonAuthenticationSerializer.java), which uses [FasterXML/jackson](https://github.com/FasterXML/jackson) to serialize the token to JSON.
 
 The supplied implementation currently only supports [`org.springframework.security.authentication.UsernamePasswordAuthenticationToken`](core/src/main/java/org/springframework/security/authentication/UsernamePasswordAuthenticationToken.java), and the principal object stored on the token must be de/serializable by Jackson. The class [`org.springframework.security.jackson2.UserMixin`](src/main/java/org/springframework/security/jackson2/UserMixin.java) demonstrates how Jackson de/serialization support can be implemented, using the class [`org.springframework.security.core.userdetails.User`](https://github.com/spring-projects/spring-security/blob/master/core/src/main/java/org/springframework/security/core/userdetails/User.java) supplied by Spring Security as an example.
 
 Users of this library are free to use an alternative serialization mechanism by supplying another implementation of this interface.

## Encrypting and signing the authentication cookie

`CookieSecurityContextRepository` uses [`au.gov.dto.springframework.security.web.context.TokenEncryption`](src/main/java/au/gov/dto/springframework/security/web/context/TokenEncryption.java) to ensure confidentiality and integrity protection for the serialized authentication token. The supplied implementation of this interface is [`au.gov.dto.springframework.security.web.context.JwtEncryption`](src/main/java/au/gov/dto/springframework/security/web/context/JwtEncryption.java), which uses [connect2id/nimbus-jose-jwt](https://bitbucket.org/connect2id/nimbus-jose-jwt/wiki/Home) to create a [JSON Web Token (JWT)](https://jwt.io/) that is signed and encrypted using [Javascript Object Signing and Encryption (JOSE)](http://jose.readthedocs.io/en/latest/).
 
Users of this library are free to use an alternative signing and encryption mechanism by supplying another implementation of this interface.

For the default implementation, the 256-bit key used to sign and encrypt should be supplied in Base64 encoded form as a constructor argument to [`au.gov.dto.springframework.security.web.context.JwtEncryption`](src/main/java/au/gov/dto/springframework/security/web/context/JwtEncryption.java). For the sample application in the [`src/sampleapp`](src/sampleapp) directory, the key can be supplied either as an environment variable called `SESSION_ENCRYPTION_KEY_BASE64` or a JVM system property called `session.encryption.key.base64`.
 
To generate a 256-bit (32 bytes) key for encrypting and signing you can use this command on Unix and macOS:

    openssl rand 32 | base64

Alternatively you can use the following Java code:
 
    java.security.SecureRandom secureRandom = new java.security.SecureRandom();
    byte[] key = new byte[32];
    secureRandom.nextBytes(key);
    String encodedKey = java.util.Base64.getEncoder().encodeToString(key);
    System.out.println(encodedKey);

## Example application

The application in the [`src/sampleapp`](src/sampleapp) directory provides an example of wiring up the classes from this library. The main files to look at are [`au.gov.dto.springframework.security.sample.config.AppConfig`](src/sampleapp/java/au/gov/dto/springframework/security/sample/config/AppConfig.java) and [`au.gov.dto.springframework.security.sample.config.WebSecurityConfig`](src/sampleapp/java/au/gov/dto/springframework/security/sample/config/WebSecurityConfig.java).

The key used to sign and encrypt the authentication cookie can be supplied either as an environment variable called `SESSION_ENCRYPTION_KEY_BASE64` or a JVM system property called `session.encryption.key.base64`. To allow the application to run without additional configuration, a dummy value has been put in [`src/sampleapp/resources/application.yml`](src/sampleapp/resources/application.yml).

Additionally, the code used in this library has been used by [AusDTO/citizenship-appointment-server](https://github.com/AusDTO/citizenship-appointment-server) in production since January 2016. 
